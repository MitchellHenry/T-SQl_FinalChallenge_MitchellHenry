/*
Deployment script for 102661522

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "102661522"
:setvar DefaultFilePrefix "102661522"
:setvar DefaultDataPath ""
:setvar DefaultLogPath ""

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING ON,
                ANSI_WARNINGS ON,
                ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ALLOW_SNAPSHOT_ISOLATION OFF;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE (CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 30), MAX_STORAGE_SIZE_MB = 100) 
            WITH ROLLBACK IMMEDIATE;
    END


GO
PRINT N'Rename refactoring operation with key f8dd1221-b444-4c06-b9b1-4d38bc701a06 is skipped, element [dbo].[Record].[Id] (SqlSimpleColumn) will not be renamed to RecordID';


GO
PRINT N'Rename refactoring operation with key 68294bda-cfd8-4419-868d-a524dc4627c9 is skipped, element [dbo].[Special_Interests].[Id] (SqlSimpleColumn) will not be renamed to InterestCode';


GO
PRINT N'Rename refactoring operation with key bb935e60-e74a-438d-bd7b-0b0c21684140 is skipped, element [dbo].[Customer].[Id] (SqlSimpleColumn) will not be renamed to CustNo';


GO
PRINT N'Rename refactoring operation with key 502f10eb-493d-4f50-85a7-bb659e01b090 is skipped, element [dbo].[Sale].[Id] (SqlSimpleColumn) will not be renamed to SaleDate';


GO
PRINT N'Rename refactoring operation with key f3b4902b-d82d-469d-96a0-5ec483cb9ceb is skipped, element [dbo].[Sale].[CustID] (SqlSimpleColumn) will not be renamed to CustnNo';


GO
PRINT N'Creating [dbo].[Customer]...';


GO
CREATE TABLE [dbo].[Customer] (
    [CustNo]       INT           NOT NULL,
    [CustName]     NVARCHAR (50) NOT NULL,
    [CustAddress]  NVARCHAR (50) NOT NULL,
    [PostCode]     INT           NOT NULL,
    [InterestCode] NVARCHAR (50) NOT NULL,
    PRIMARY KEY CLUSTERED ([CustNo] ASC)
);


GO
PRINT N'Creating [dbo].[Record]...';


GO
CREATE TABLE [dbo].[Record] (
    [RecordID]  NVARCHAR (50) NOT NULL,
    [Title]     NVARCHAR (50) NOT NULL,
    [Performer] NVARCHAR (50) NOT NULL,
    PRIMARY KEY CLUSTERED ([RecordID] ASC)
);


GO
PRINT N'Creating [dbo].[Sale]...';


GO
CREATE TABLE [dbo].[Sale] (
    [SaleDate]  INT           NOT NULL,
    [PricePaid] MONEY         NOT NULL,
    [RecordID]  NVARCHAR (50) NOT NULL,
    [CustNo]    INT           NOT NULL,
    PRIMARY KEY CLUSTERED ([SaleDate] ASC, [RecordID] ASC, [CustNo] ASC)
);


GO
PRINT N'Creating [dbo].[Special_Interests]...';


GO
CREATE TABLE [dbo].[Special_Interests] (
    [InterestCode] NVARCHAR (50)  NOT NULL,
    [InterestDesc] NVARCHAR (MAX) NULL,
    PRIMARY KEY CLUSTERED ([InterestCode] ASC)
);


GO
PRINT N'Creating unnamed constraint on [dbo].[Customer]...';


GO
ALTER TABLE [dbo].[Customer] WITH NOCHECK
    ADD FOREIGN KEY ([InterestCode]) REFERENCES [dbo].[Special_Interests] ([InterestCode]);


GO
PRINT N'Creating unnamed constraint on [dbo].[Sale]...';


GO
ALTER TABLE [dbo].[Sale] WITH NOCHECK
    ADD FOREIGN KEY ([RecordID]) REFERENCES [dbo].[Record] ([RecordID]);


GO
PRINT N'Creating unnamed constraint on [dbo].[Sale]...';


GO
ALTER TABLE [dbo].[Sale] WITH NOCHECK
    ADD FOREIGN KEY ([CustNo]) REFERENCES [dbo].[Customer] ([CustNo]);


GO
-- Refactoring step to update target server with deployed transaction logs

IF OBJECT_ID(N'dbo.__RefactorLog') IS NULL
BEGIN
    CREATE TABLE [dbo].[__RefactorLog] (OperationKey UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    EXEC sp_addextendedproperty N'microsoft_database_tools_support', N'refactoring log', N'schema', N'dbo', N'table', N'__RefactorLog'
END
GO
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'f8dd1221-b444-4c06-b9b1-4d38bc701a06')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('f8dd1221-b444-4c06-b9b1-4d38bc701a06')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '68294bda-cfd8-4419-868d-a524dc4627c9')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('68294bda-cfd8-4419-868d-a524dc4627c9')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'bb935e60-e74a-438d-bd7b-0b0c21684140')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('bb935e60-e74a-438d-bd7b-0b0c21684140')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '502f10eb-493d-4f50-85a7-bb659e01b090')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('502f10eb-493d-4f50-85a7-bb659e01b090')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'f3b4902b-d82d-469d-96a0-5ec483cb9ceb')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('f3b4902b-d82d-469d-96a0-5ec483cb9ceb')

GO

GO
DELETE FROM Sale;
DELETE FROM Special_Interests;
DELETE FROM Customer;
DELETE FROM Record;

INSERT INTO Special_Interests(InterestCode,InterestDesc)
VALUES('RR','Rock and Roll'),
('JA','Jazz'),
('RB','Rhythm and Blues'),
('RR','Rock and Roll'),
('RB','Rhythm and Blues');

INSERT INTO Record(RecordID,Title,Performer)
VALUES('PF003','The Wall','Pink Floyed'),
('IX002','Kick','IXNS'),
('SP069','Never Mind The Bollocks','Sex Pistols'),
('PF002','Dark Side of the Moon','Pink Floyed'),
('IX005','Shabooh Shoobah','INXS'),
('SP070','Floggin a Dead Horse','Sex Pistols'),
('PF004','The Endless River','Pink Floyed'),
('PF006','Wish You Were Here','Pink Floyed'),
('SP075','Agents of Anarchy','Sex Pistols'),
('PF007','The Division Bell','Pink Floyed');

INSERT INTO Customer(CustNo,CustName,CustAddress,PostCode,InterestCode)
VALUES(123,'Jimmy Barnes',1, 'Sesame Street',3000,'RR'),
(456,'Ian Moss','10 Downing Street',4000,'JA'),
(789,'Don Walker','221B Baker Street',5000,'RB'),
(234,'Steve Prestwich','LG1 College Cres, Parkville',6000,'RR'),
(567,'Phil Small','1 Adelaide Avenue',7000,'RB');

INSERT INTO Sale(SaleDate,PricePaid,RecordID,CustNo)
VALUES('1-Dec-2015',30.00,'PF003',123),
('1-Dec-2015',29.95,'IX002',123),
('2-Dec-2015',12.45,'SP069',123),
('5-Dec-2015',30.00,'IX002',123),
('1-Dec-2015',31.00,'PF002',456),
('3-Dec-2015',28.95,'IX005',456),
('6-Dec-2015',13.45,'SP070',456),
('2-Dec-2015',29.00,'PF004',789),
('3-Dec-2015',29.95,'IX002',789),
('1-Dec-2015',45.00,'PF006',234),
('4-Dec-2015',5.67,'SP075',234),
('3-Dec-2015',9.95,'PF007',567);

GO

GO
